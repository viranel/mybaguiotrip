name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for web
      run: npx expo export --platform web
      
    - name: Fix security headers and compatibility
      run: |
        # Create proper index.html with security headers
        cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="utf-8" />
          <meta http-equiv="X-UA-Compatible" content="IE=edge" />
          <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
          <meta name="theme-color" content="#FF7A2E" />
          <meta name="description" content="An AI-powered travel planning application for Baguio City, Philippines" />
          <title>My Baguio Trip - AI-Powered Travel Planning</title>
          <link rel="icon" href="/favicon.ico" />
          <style>
            /* Fix CSS compatibility issues */
            * {
              -webkit-text-size-adjust: 100%;
              -moz-text-size-adjust: 100%;
              text-size-adjust: 100%;
            }
            
            /* Fix scrollbar compatibility */
            ::-webkit-scrollbar {
              width: 8px;
            }
            
            ::-webkit-scrollbar-track {
              background: #f1f1f1;
            }
            
            ::-webkit-scrollbar-thumb {
              background: #888;
              border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
              background: #555;
            }
            
            /* Fallback for browsers that don't support scrollbar-width */
            @supports not (scrollbar-width: thin) {
              ::-webkit-scrollbar {
                width: 8px;
              }
            }
            
            /* Ensure content loads */
            body {
              margin: 0;
              padding: 0;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            }
            
            #root {
              width: 100%;
              height: 100vh;
            }
          </style>
        </head>
        <body>
          <noscript>You need to enable JavaScript to run this app.</noscript>
          <div id="root"></div>
        </body>
        </html>
        EOF
        
        # Create .htaccess for Apache servers (GitHub Pages)
        cat > dist/.htaccess << 'EOF'
        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # Cache control
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg)$">
          Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
        
        # Content type
        AddType text/html .html
        AddDefaultCharset utf-8
        EOF
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
